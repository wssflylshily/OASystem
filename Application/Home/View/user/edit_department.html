<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html">
<head>
	<meta charset="utf-8" />
	<title>南开创文</title>
	<link rel="stylesheet" href="__PUBLIC__/css/style.css" />
	<script type="text/javascript" src="__PUBLIC__/js/jquery-1.12.4.min.js" ></script>
	<script type="text/javascript" src="__PUBLIC__/js/layer/layer.js" ></script>
	<script type="text/javascript" src="__PUBLIC__/js/laydate/laydate.js"></script>

	<script type="text/javascript" charset="utf-8" src="__PUBLIC__/ueditor/ueditor.config.js"></script>
	<script type="text/javascript" charset="utf-8" src="__PUBLIC__/ueditor/ueditor.all.min.js"> </script>
	<script type="text/javascript" charset="utf-8" src="__PUBLIC__/ueditor/lang/zh-cn/zh-cn.js"></script>

	<style>
		#doc_type{
			/*position: relative;*/
			z-index:100;
			text-align: left;
			padding: 0px;
			top: inherit;
		}
	</style>
</head>
<body>

<include file="_layouts/left_bar" />
<!--中间内容-->

<div class="content" style="overflow: visible">
	<div>
		<div class="email_com font12 nobor">
			<span class="tufa_icon font16"><b>编辑部门</b></span>
		</div>
		<div class="font13">
			<table class="email_table">
				<tr>
					<td colspan="6">
						<table class="email_table email_table1"><tr>
							<td width="120">部门名称：</td>
							<td><div class="div1">
								<input type="text" name="rwbt" placeholder="输入部门名称" autocomplete="off" value="{$rs.d_name}">
							</div></td>
						</tr>
						</table>
					</td>
				</tr>
				<tr>
					<td colspan="3" width="50%">
						<table class="email_table email_table1"><tr>
							<td width="120">上级部门：</td>
							<td><div class="div1 xldiv">
								<input type="hidden" name="qtdwid" id="qtdwid">
								<input class="select_qiantou" type="text" name="qtdw" value="{$rs.parent_name}" placeholder="选择上级部门">
							</div></td>
						</tr></table>
					</td>
				</tr>
				<tr>
					<td colspan="1" width="33.333%">
						<table class="email_table email_table1"><tr>
							<td width="120">选择部门分类：</td>
							<td><div class="div1 xldiv" style="position: relative; z-index:99">
								<input type="text" name="rwlx" autocomplete="off" value="{$rs.dp_name}" placeholder="选择分类">
								<div id="doc_type" class="select_box xxfl_s Hide">
									<input type="hidden" name="lxdwid"  value="{$rs.dp_category_task_id}">
									<div class="ulcontent">
										<ul>
											<li data-id="5">区级领导</li>
											<li data-id="-1">创文办</li>
											<li data-id="1">委员单位</li>
											<li data-id="2">成员单位</li>
											<li data-id="3">街道</li>
											<li data-id="4">各指挥部</li>
											<li data-id="6">社区</li>
										</ul>
									</div>
								</div>
							</div></td>
						</tr>
						</table>
					</td>
					<td colspan="1" width="33.333%">
						<table class="email_table email_table1"><tr>
							<td width="120">选择邮件分类：</td>
							<td><div class="div1 xldiv" style="position: relative; z-index:99">
								<input type="text" name="rwlx" autocomplete="off" value="{$rs.email_name}" placeholder="选择分类">
								<div class="select_box xxfl_s Hide">
									<input type="hidden" name="emailid" value="{$rs.department_category_id}">
									<div class="ulcontent">
										<ul>
											<li data-id="5">区级领导</li>
											<li data-id="-1">创文办</li>
											<li data-id="1">委员单位</li>
											<li data-id="2">成员单位</li>
											<li data-id="3">街道</li>
											<li data-id="4">各指挥部</li>
											<li data-id="6">社区</li>
										</ul>
									</div>
								</div>
							</div></td>
						</tr>
						</table>
					</td>
                    <tr>
                        <td colspan="6">
                            <table class="email_table email_table1"><tr>
                                <td width="120">排序：</td>
                                <td><div class="div1">
                                    <input type="text" name="sort" value="{$rs.sort}" placeholder="输入排序" autocomplete="off">
                                </div></td>
                            </tr>
                            </table>
                        </td>
                    </tr>
				</tr>
			</table>
		</div>
		<div class="email_com nobor font12">
			<button type="button" class="buttonc green user_add" style="width: 60px;"> 确认</button>
			&nbsp;&nbsp;<a href="javascript:history.go(-1);"><button type="button" class="buttonc" style="width: 60px;"> 取消</button></a>
		</div>
	</div>
</div>

<!--new add 2017-4-14-->
<!--牵头单位-->
<div id="houqinr_qiantou" style="display:none">
	<input type="hidden" class="inputHide" name="sjbm" value="{$rs.parent_id}">
	<div class="houqi_select clear">
		<div class="L col-6">
			<div class="houqi_search">
				<div class="search_txt clear font13">
					<input class="L" name="search_con" type="text">
					<span class="R"></span>
				</div>
			</div>
			<div class="h_one">
				<div class="h_search" id="sssss">
					<dl>
						<dd>

						</dd>
					</dl>
				</div>
				<div class="h_content">
					<dl>
						<dd class="clear"><div class="Show txt_oneline" data_id="1">创文办</div></dd>
					</dl>
					<dl>
						<dd class="clear"><div class="Show txt_oneline" data_id="7">区领导</div></dd>
					</dl>
					<foreach name="depCate" item="rs">
						<dl>
							<dt><span class="div_inblock one"><b>{$rs.category_name}</b></span><span>(<?php echo count($rs['data']) ?>)</span>
								<em class="add_all" title="添加整组" style="color: red;float: right"> </em></dt>

							<dd class="clear" style="display: none;">
								<foreach name="rs['data']" item="item">
									<div class="Show txt_oneline" data_id="{$item.id}">{$item.d_name}</div>
								</foreach>
							</dd>

						</dl>
					</foreach>
				</div>

			</div>
		</div>
		<div class="R col-6">
			<div style="padding: 10px; line-height: 10px;">已选择：</div>
			<div class="h_one">
				<ul class="houqi_old">
					<if condition="$old_parent neq null">
						<foreach name="old_parent" item="a">
							<li class="clear"><div class="L txt_oneline">{$a.d_name}</div><div class="R" data_id="{$a.id}"></div></li>
						</foreach>
					</if>
				</ul>
			</div>
		</div>
	</div>
	<div class="center_btn"><button type="button" class="buttonc red houqi_ok">确定</button></div>
</div>
<!--牵头单位-->

<!--new add 2017-4-12 end-->
<!--脚本-->
<script>
    $(function() {
        //添加完成
        $(document).on("click",".user_add",function(){

            var name=$("input[name='rwbt']").val();
            var ssdw=$("input[name='sjbm']").val();
            var fl=$("input[name='lxdwid']").val();
            var emailid=$("input[name='emailid']").val();
            var sort=$("input[name='sort']").val();
            var id = "{$id}";

//                    alert(ssdw);return;
//                    var user_id = $(this).attr('data-id');
            if(name=="")
            {
                layer.msg('部门名称不能为空');
                return false;
            }
            if(ssdw=="")
            {
                layer.msg('上级单位不能为空');
                return false
            }
            if(fl=="")
            {
                layer.msg('部门分类不能为空');
                return false
            }
            if(emailid=="")
            {
                layer.msg('邮件分类不能为空');
                return false
            }

            //新增
            $.ajax({
                type : 'post',
                url : '{:U("Home/User/edit_department")}',
                data : {name:name,ssdw:ssdw,fl:fl, emailid:emailid, id:id,sort:sort},
                dataType : 'json',
                success : function(res){
                    if(res.status == 1){
                        layer.msg(res.msg);
                        location=location;
                    }else{
                        layer.msg(res.msg);
                        return false;
                    }
                },
                error : function(XMLHttpRequest, textStatus, errorThrown) {
                    layer.msg('网络失败，请刷新页面后重试');
                    return false;
                }
            })
            //console.log(html);
            $(".layui-layer-close").click();
        });

        //中间搜索部分

        //new2017-4-14 start
        var obj;
        var input_obj;
        $(document).on("click", ".houqi_select dl dt span", function () {
            $(this).parent().siblings("dd").toggle();
        });
        //选择牵头单位
        $(".select_qiantou").click(function () {
            //obj=$(this);
            obj = $("#houqinr_qiantou");
            input_obj = $(this);

            var name = "上级部门";
            layer.open({
                title: name,
                type: 1,
                skin: 'layui-box', //加上边框
                area: ['620px', '422px'], //宽高
                content: '<div class="select_tanchu clear"></div>'
            });
            $(".select_tanchu").html(obj.html());
        });
        //选择责任单位
        $(".select_zeren").click(function () {
            //obj=$(this);
            obj = $("#houqinr_zeren");
            input_obj = $(this);

            var name = "责任单位";
            layer.open({
                title: name,
                type: 1,
                skin: 'layui-box', //加上边框
                area: ['620px', '422px'], //宽高
                content: '<div class="select_tanchu clear"></div>'
            });
            $(".select_tanchu").html(obj.html());
        });
        //搜索
        $(document).on("input propertychange", ".houqi_search .search_txt input", function () {
            var a=$(this);
            if ($(this).val() != "") {
                $(this).siblings(".R").addClass("delete");
                $(this).parents(".houqi_search").siblings(".h_one").children(".h_search").show();
                $(this).parents(".houqi_search").siblings(".h_one").children(".h_content").hide();

                var keyword = $(this).val();

                $.ajax({
                    type: "GET",
                    url: "__ROOT__/home/user/searchDepartmentAjax",
                    data: {keyword: keyword},
                    success: function (json) {
                        var data = JSON.parse(json);
                        console.log(data);
                        var str = "";
                        if (data) {
                            for (var i = 0; i < data.length; i++) {
                                str += '<div class="Show txt_oneline" data_id="'+data[i].id+'">'+data[i].d_name+'</div>';
                            }
                        }
                        console.log(str);
                        a.parents(".houqi_search").siblings(".h_one").find(".h_search dl dd").html(str);
                    }
                });

            }
            else {
                $(this).siblings(".R").removeClass("delete");
                $(this).parents(".houqi_search").siblings(".h_one").children(".h_search").hide();
                $(this).parents(".houqi_search").siblings(".h_one").children(".h_content").show();
            }

        });
        //置为空
        $(document).on("click", ".houqi_search .search_txt .delete", function () {
            $(this).siblings("input").val("");
            $(this).parents(".houqi_search").siblings(".h_one").children(".h_search").hide();
            $(this).parents(".houqi_search").siblings(".h_one").children(".h_content").show();
            $(this).removeClass("delete");
        });
        //单个选择添加
        $(document).on("click", ".select_tanchu dl dd div", function () {
            var s_id = $(this).attr("data_id");
            var s_name = $(this).html();
            //判断是否有重复
            var old_id = [];
            var panduan = true;
            for (var i = 0; i < $(this).parents(".houqi_select").find(".houqi_old .R").length; i++) {
                old_id[i] = $(this).parents(".houqi_select").find(".houqi_old .R:eq(" + i + ")").attr("data_id");
                if (s_id == old_id[i]) {
                    panduan = false;
                }
            }
            if (panduan) {
                var add_str = '<li class="clear"><div class="L txt_oneline">' + s_name + '</div><div class="R" data_id="' + s_id + '"></div></li>';
                $(this).parents(".houqi_select").find(".houqi_old").append(add_str);
            }

        });
        //添加全部
        $(document).on("click", ".select_tanchu dl dt .add_all", function () {
            //初始所有选中
            var old_id = [];
            for (var i = 0; i < $(this).parents(".houqi_select").find(".houqi_old .R").length; i++) {
                old_id[i] = $(this).parents(".houqi_select").find(".houqi_old .R:eq(" + i + ")").attr("data_id");
            }
            for (var j = 0; j < $(this).parents("dt").siblings("dd").find("div").length; j++) {
                var s_id = $(this).parents("dt").siblings("dd").find("div:eq(" + j + ")").attr("data_id");
                var s_name = $(this).parents("dt").siblings("dd").find("div:eq(" + j + ")").html();
                //判断是否有重复
                var panduan = true;
                for (var k = 0; k < old_id.length; k++) {
                    if (s_id == old_id[k]) {
                        panduan = false;
                    }
                }
                if (panduan) {
                    var add_str = '<li class="clear"><div class="L txt_oneline">' + s_name + '</div><div class="R" data_id="' + s_id + '"></div></li>';
                    $(this).parents(".houqi_select").find(".houqi_old").append(add_str);
                }
            }
        });
        //选择删除
        $(document).on("click", ".select_tanchu .houqi_old li .R", function () {
            $(this).parents("li").remove();
        });
        //后期ok
        $(document).on("click", ".houqi_ok", function () {
            obj.html($(this).parents(".select_tanchu").html());
            $(".houqi_search .search_txt .delete").click();
            var str_id = "", str_name = "";
            for (var i = 0; i < obj.find(".houqi_old .R").length; i++) {
                //old_id[i]=$(this).parents(".houqi_select").find(".houqi_old .R:eq("+i+")").attr("data_id");
                str_id += obj.find(".houqi_old .R:eq(" + i + ")").attr("data_id");
                str_name += obj.find(".houqi_old .R:eq(" + i + ")").siblings(".L").html();
                if (i != obj.find(".houqi_old .R").length - 1) {
                    str_id += ",";
                    str_name += ";";
                }
            }
            console.log(str_id);
            obj.find(".inputHide").val(str_id);
            alert($("input[name=sjbm]").val());
            return;
            input_obj.val(str_name);
            $(".layui-layer-close").click();
        })

        //new2017-4-12 end
        //获取焦点时显示或隐藏
        $(".xldiv input").focusin(function(){
            $(this).siblings(".select_box").show();
        });
        $(".xldiv input").click(function(){
            $(this).siblings(".select_box").show();
        });
        $(".xldiv input").on("input propertychange",function(){
            $(this).siblings(".select_box").show();

        });
        $(".xldiv").hover(function(){},function(){
            $(this).children(".select_box").hide();
        });
        //失去焦点时
        $(".xldiv input").focusout(function(){
            if(!$(this).siblings(".select_box").hasClass("leixing"))
            {
                var str=$(this).val();
                var stra=str.split(";");
                str="";
                for(var i=0;i<stra.length;i++)
                {
                    if(stra[i]!="")
                    {
                        str+=stra[i]+";";
                    }
                }
                $(this).val(str);
            }

        });

        $(document).on("click",".select_box .ulcontent li",function(){
            //类型选择
            $(this).parents(".select_box").siblings("input").val($(this).html());
            $(this).parents(".select_box").hide();

            var id = $(this).attr('data-id');
//                        $("#lxdwid").val(id);
            $(this).parents(".ulcontent").siblings("input").val(id);
        })


    })

</script>
</body>
</html>
<script>
    $('#config').parents("#menu").find("dl,dd").removeClass("on");
    $('#config').parents("#menu").find("dd").removeClass("Show");
    $('#config').addClass("on");
    $('#cdep').addClass("on");
    $('#cdep').parents("dd").addClass("Show");

</script>

